<!doctype html>
<html lang="ko" data-theme="light">
<head>
<style id="toast-style">
  #toast{
    position:fixed; right:16px; bottom:16px; z-index:10000; display:none;
    padding:10px 12px; border-radius:10px; border:1px solid #1f2937;
    background:#0b0e12; color:#e9eef5; font:13px/1.4 system-ui
  }
  #toast.ok{ border-color:#10b981 }
  #toast.err{ border-color:#ef4444 }
</style>

<style id="preview-mark-style">
  #previewBody mark{
    background:#fde68a; color:inherit; border-radius:3px; padding:0 1px;
  }
</style>
<style id="preview-fade-style">
  #previewModal{ opacity:0; transition:opacity .18s ease; }
  #previewModal.on{ opacity:1; }
  #previewModal .panel{ transition:transform .18s ease, opacity .18s ease; transform:translateY(8px); opacity:.98; }
  #previewModal.on .panel{ transform:translateY(0); opacity:1; }
</style>

  <meta charset="utf-8"/>
  <title>QualiJournal â€” Admin (Unified)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- ê¸°ë³¸ UI ìŠ¤íƒ€ì¼ -->
  <style>
    :root{
      --bg:#ffffff; --ink:#1a1d20; --muted:#64748b; --line:#e2e8f0;
      --card:#ffffff; --panel:#f8fafc; --acc:#2563eb; --ok:#24c08b;
      --warn:#f0b600; --err:#ef4444;
    }
    [data-theme="dark"]{
      --bg:#0b0e12; --ink:#e9eef5; --muted:#8ea1b2; --line:#223047;
      --card:#10161d; --panel:#0f141b; --acc:#1e90ff; --ok:#24c08b;
      --warn:#f0b600; --err:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);
      font:14px/1.6 ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    main{padding:16px;display:grid;grid-template-columns:300px 1fr;gap:16px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    input,button{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:var(--panel);color:var(--ink)}
    button{cursor:pointer}
    button.primary{background:var(--acc);border-color:var(--acc);color:#fff}
    button.ok{background:var(--ok);border-color:var(--ok);color:#041b12}
    #log{white-space:pre-wrap;background:var(--panel);border:1px dashed var(--line);
      padding:10px;border-radius:8px;margin-top:8px;max-height:48vh;overflow:auto}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi .box{background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:10px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);
      color:var(--muted);font-size:12px;background:var(--panel)}
    a.pill{color:var(--acc);text-decoration:none}
    /* ëª¨ë‹¬ */
    #jobModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999}
    #jobCard{max-width:780px;margin:60px auto;background:var(--card);
      border:1px solid var(--line);border-radius:12px;padding:14px}
    .steps{margin-top:10px}
    .task-log{border-left:4px solid var(--line);padding:8px 10px;margin:6px 0;background:var(--panel);border-radius:8px;font:12px/1.5 ui-monospace,Consolas,monospace}
    .meta{color:var(--muted);font-size:12px}
    canvas{width:100%;height:140px;border:1px solid var(--line);border-radius:8px;background:var(--panel)}
    /* ë¹„ë™ê¸° íŒ¨ë„ */
    .task-panel{border:1px solid var(--line);border-radius:10px;padding:14px;margin:14px 0;background:var(--panel)}
    .task-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .sse-log{background:#0a0f1a;color:#d2e3ff;border-radius:8px;padding:10px;height:240px;overflow:auto;font:12px/1.5 ui-monospace,Consolas,monospace}
    .btn{padding:8px 12px;border:1px solid #5a6aa6;border-radius:8px;background:#0f1730;color:#d2e3ff;cursor:pointer}
    .btn:hover{background:#16224a}
    .muted{color:#9fb2ff;font-size:12px}
    .kwin{padding:8px 10px;border:1px solid #5a6aa6;border-radius:8px;background:#0f1730;color:#d2e3ff}
  </style>

  <!-- ëª¨ë“  /api/* ìš”ì²­ì— ADMIN í† í° ìë™ ë¶€ì°© (ì ˆëŒ€Â·ìƒëŒ€ URL ëª¨ë‘ ì§€ì›) -->
  <script>
  (function () {
    function getToken(){ return (localStorage.getItem('ADMIN_TOKEN') || '').trim(); }
    const _fetch = window.fetch.bind(window);
    window.fetch = function(input, init){
      init = init || {};
      let reqUrl;
      try{
        const raw = (typeof input === 'string') ? input : (input && input.url) || '';
        reqUrl = new URL(raw, location.origin);
      }catch(_){
        reqUrl = new URL(String(input || ''), location.origin);
      }
      const isApi = !!(reqUrl && reqUrl.pathname && reqUrl.pathname.startsWith('/api/'));
      const headers = new Headers(init.headers || {});
      const tok = getToken();
      if (isApi && tok && !headers.has('Authorization')) {
        headers.set('Authorization', 'Bearer ' + tok);
      }
      init.headers = headers;
      if (input instanceof Request) {
        input = new Request(reqUrl.toString(), init);
        return _fetch(input);
      }
      return _fetch(reqUrl.toString(), init);
    };
  })();
  </script>

</head>
<body>
<!-- === BUILD BADGE (auto-stamp, KST) === -->
<div id="build-badge" style="position:fixed;top:6px;left:12px;z-index:9999;font:12px/1.4 system-ui;">
  <span id="build-text" style="padding:2px 6px;border-radius:6px;background:#eef;color:#111;"></span>
</div>
<script>
(function(){
  // hide with ?badge=off
  const qs = new URLSearchParams(location.search);
  if (qs.get("badge")==="off") { document.getElementById("build-badge").style.display="none"; return; }

  // KST timestamp: vYYYY-MM-DD_HHMM
  const parts = new Intl.DateTimeFormat('en-US', {
    timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', hour12:false
  }).formatToParts(new Date()).reduce((a,p)=> (a[p.type]=p.value, a), {});
  const stamp = `${parts.year}-${parts.month}-${parts.day}_${parts.hour}${parts.minute}`;
  document.getElementById("build-text").textContent = `BUILD: v${stamp} (KST)`;
})();
</script>
<!-- === /BUILD BADGE === -->

<header>
  <div>
    <h1>QualiJournal â€” Admin</h1>
    <div class="sub">í•˜ë£¨ í•œ í‚¤ì›Œë“œ Â· HiTL Â· ìŠ¹ì¸â‰¥15 Â· ì›í´ë¦­ ë°œí–‰</div>
  </div>
  <div class="sub">API: <span id="api-badge"></span>
    <button id="theme-toggle" onclick="toggleTheme()" style="margin-left:8px;">ë‹¤í¬ ëª¨ë“œ</button>
  </div>
</header>

<main>
  <!-- ì¢Œ: ìƒíƒœ/ìŠ¹ì¸ -->
  <section class="card" aria-labelledby="sec-status">
    <h3 id="sec-status">ìƒíƒœ</h3>
    <div class="row">
      <input id="date" aria-label="ë‚ ì§œ"/>
      <input id="kw" aria-label="í‚¤ì›Œë“œ" value="IPC-A-610"/>
      <button class="primary" onclick="refresh()">ìƒˆë¡œê³ ì¹¨</button>
      <!-- AUTO-REFRESH TOGGLE (idempotent) -->
      <div class="row" id="autoRefreshRow" style="gap:8px">
        <label for="autoRefreshToggle" class="pill">ìë™ ìƒˆë¡œê³ ì¹¨(30ì´ˆ)</label>
        <input id="autoRefreshToggle" type="checkbox" onchange="toggleAutoRefresh(this.checked)">
      </div>

    </div>
    <div class="kpi" role="group" aria-label="KPI">
      <div class="box">ì„ ì •ë³¸ ì´ëŸ‰: <b id="selTotal">-</b></div>
      <div class="box">ì„ ì •ë³¸ ìŠ¹ì¸: <b id="selApproved">-</b></div>
      <div class="box">ì»¤ë®¤ë‹ˆí‹° í›„ë³´: <b id="comTotal">-</b></div>
      <div class="box">í‚¤ì›Œë“œ íŠ¹ì§‘: <b id="kwTotal">-</b></div>
      <div class="box">í›„ë³´: <b id="cntCandidate">-</b></div>
      <div class="box">ì¤€ë¹„ì™„ë£Œ: <b id="cntReady">-</b></div>
      <div class="box">ê±°ì ˆ: <b id="cntRejected">-</b></div>
    </div>
    <div class="row">
      <span class="pill">ê²Œì´íŠ¸(ìŠ¹ì¸ â‰¥ <span id="gateReq">15</span>): <b id="gatePass">-</b></span>
      <button onclick="startApprove()">ìŠ¹ì¸ UI ì—´ê¸°</button>
      <a class="pill" id="uiLink" href="#" target="_blank" rel="noopener"></a>
    </div>

    <section id="readyPanel" class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">ì¤€ë¹„ì™„ë£Œ(Ready) ëª©ë¡</h3>
        <div class="row">
          <button class="primary" onclick="loadReady()">Ready ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button onclick="refresh()">KPI ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      <div id="readyList" style="margin-top:8px;display:grid;gap:8px"></div>
    </section>

    <!-- ê²Œì´íŠ¸ ì¡°ì • ìŠ¬ë¼ì´ë” -->
    <div class="row" style="gap:12px">
      <label for="gateSlider" class="pill" style="margin-right:4px">ê²Œì´íŠ¸ ì¡°ì ˆ:</label>
      <input id="gateSlider" type="range" min="1" max="30" value="15"
             oninput="document.getElementById('gateVal').textContent=this.value"
             onchange="updateGate(this.value)">
      <span id="gateVal" class="pill">15</span>
    </div>

    <div id="log" role="region" aria-live="polite">ì—¬ê¸°ì— ê²°ê³¼ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </section>

  <!-- ìš°: ìš´ì˜ -->
  <section class="card" aria-labelledby="sec-ops">
    <h3 id="sec-ops">ìš´ì˜</h3>
    <div class="row">
      <button class="primary" onclick="runMerged()">ì›í´ë¦­(í†µí•© ë°œí–‰)</button>
      <button class="primary" onclick="runDaily()">ì›í´ë¦­(ì»¤ë®¤ë‹ˆí‹°)</button>
      <button onclick="runCommunity()">ì»¤ë®¤ë‹ˆí‹° ìˆ˜ì§‘</button>
    </div>

    <h4>í‚¤ì›Œë“œ íŠ¹ì§‘</h4>
    <div class="row">
      <button class="ok" onclick="runKeyword()">ìˆ˜ì§‘â†’ìŠ¹ì¸Top20â†’ë°œí–‰</button>
    </div>

    <h4>ì‘ì—… ëª¨ë‹ˆí„°</h4>
    <div class="row">
      <button onclick="showRecent()">ìµœê·¼ ì‘ì—…</button>
    </div>

    <h4>ë³´ê³ ì„œÂ·ìš”ì•½Â·ë‚´ë³´ë‚´ê¸°</h4>
    <div class="row" style="flex-wrap:wrap">
      <input id="reportDate" type="date" aria-label="ë³´ê³ ì„œ ë‚ ì§œ">
      <input id="reportKw" placeholder="í‚¤ì›Œë“œ (ì„ íƒ)" aria-label="ë³´ê³ ì„œ í‚¤ì›Œë“œ">
      <button onclick="genReport()">ë³´ê³ ì„œ ìƒì„±</button>
      <button onclick="enrichKeyword()">í‚¤ì›Œë“œ ìš”ì•½/ë²ˆì—­</button>
      <button onclick="enrichSelection()">ì„ ì •ë³¸ ìš”ì•½/ë²ˆì—­</button>
      <button onclick="previewMd()">MD ë¯¸ë¦¬ë³´ê¸°</button>
      <button onclick="exportMd()">MD ë‚´ë³´ë‚´ê¸°</button>
      <button onclick="exportCsv()">CSV ë‚´ë³´ë‚´ê¸°</button>
    </div>

    <p id="resultRow" style="margin-top:8px; display:none;">
      ê²°ê³¼: <a id="outLink" href="#" target="_blank" rel="noopener" download>ì—´ê¸°</a>
    </p>
  </section>
</main>

<!-- ì§„í–‰ë¥  ëª¨ë‹¬ -->
<div id="jobModal">
  <div id="jobCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">ì‘ì—… ì§„í–‰ìƒí™©</h3>
      <div>
        <button id="cancelBtn" onclick="cancelJob()" style="margin-right:6px;">ì‘ì—… ì·¨ì†Œ</button>
        <button onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
    <div class="meta" id="jobMeta"></div>
    <div class="steps" id="steps"></div>
    <h4>íƒ€ì„ë¼ì¸</h4>
    <canvas id="timeline" width="720" height="140" aria-label="íƒ€ì„ë¼ì¸ ì°¨íŠ¸"></canvas>
  </div>
</div>

<!-- ===== ë¹„ë™ê¸° ì‘ì—… íŒ¨ë„(SSE ë¡œê·¸) ===== -->
<div class="task-panel" id="q-tasks">
  <div class="task-row">
    <strong>ë¹„ë™ê¸° ì‘ì—…</strong>
    <span class="muted" id="q-info" style="margin-left:8px"></span>
  </div>
  <div class="task-row">
    <button class="btn" onclick="startFlow('community')">ì»¤ë®¤ë‹ˆí‹° ì‹¤í–‰</button>
    <button class="btn" onclick="startFlow('daily')">ë°ì¼ë¦¬ ì‹¤í–‰</button>
    <input class="kwin" id="kwInput" placeholder="keyword (ì˜ˆ: IPC-A-610)" />
    <button class="btn" onclick="startKeyword()">í‚¤ì›Œë“œ ì‹¤í–‰</button>
    <button class="btn" onclick="stopStream()">ìŠ¤íŠ¸ë¦¼ ì •ì§€</button>
  </div>
  <div class="sse-log" id="taskLog">(ì—¬ê¸°ì— ì‹¤ì‹œê°„ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤)</div>
</div>

<!-- ===== ìƒë‹¨ ê³ ì • í† í° ë°” ===== -->
<div id="adminTokenBar" style="position:fixed; right:12px; top:12px; z-index:9999; background:#111; color:#ddd; border:1px solid #444; border-radius:10px; padding:8px 10px; display:flex; gap:8px; align-items:center; font-size:12px;">
  <span>ADMIN_TOKEN</span>
  <input id="adminToken" type="password"
         placeholder="your-admin-token-12345"
         autocomplete="new-password" autocapitalize="off" spellcheck="false"
         style="width:220px; padding:6px; border-radius:8px; border:1px solid #555; background:#222; color:#eee;">
  <button onclick="saveAdminTokenJJ()" style="padding:6px 10px;">ì…ë ¥</button>
  <button onclick="clearAdminTokenJJ()" style="padding:6px 10px;">í•´ì œ</button>
  <div id="tokenStatusChip" style="display:flex;align-items:center;gap:6px; padding:6px 10px;border-radius:999px;border:1px solid #333;background:#2b0a0a;">
    <span id="tokenStatusDot" style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;"></span>
    <strong id="tokenStatusText" style="letter-spacing:0.5px;">ë¯¸ì¸ì¦</strong>
    <span style="opacity:.6;">|</span>
    <span style="opacity:.8;">ë§ˆì§€ë§‰ í™•ì¸: <span id="tokenStatusLast">-</span></span>
  </div>
</div>

<script>
/* ===== ê³µí†µ í—¬í¼ ===== */
function showToast(msg, type){
  var t=document.getElementById('toast'); if(!t) return;
  t.className = (type==='err') ? 'err' : 'ok';
  t.textContent = String(msg||'');
  t.style.display='block';
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(function(){ t.style.display='none'; }, 1800);
}
function el(id){ return document.getElementById(id); }
function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function escapeHtml(s){ return (s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

/* API BASE ìë™ ì„¤ì • */
let API_BASE =
  localStorage.getItem("API_BASE") ||
  new URLSearchParams(location.search).get("api") ||
  location.origin;
window.API_BASE = API_BASE;
document.addEventListener("DOMContentLoaded", () => {
  var b = el("api-badge"); if(b){ b.textContent = API_BASE; }
  var a = el("uiLink"); if(a){ a.href = API_BASE; a.textContent = API_BASE; }
});

/* ë³´í˜¸ API í—¤ë” â€” ì…ë ¥ì¹¸ ê°’ì€ ë¬´ì‹œí•˜ê³  localStorageë§Œ ì‹ ë¢° */
function authHeaders(){
  var t = (localStorage.getItem('ADMIN_TOKEN') || '').trim();
  return t ? { Authorization: 'Bearer ' + t } : {};
}

/* í† í° ìƒíƒœ UI */
function setActionsEnabled(on){
  ['exportMd','exportCsv','genReport','enrichKeyword','enrichSelection']
    .forEach(name=>document.querySelectorAll('button[onclick*="'+name+'"]').forEach(b=>b.disabled=!on));
}
function updateAuthUI(ok){
  el('tokenStatusLast').textContent = new Date().toLocaleTimeString();
  var chip=el('tokenStatusChip'), txt=el('tokenStatusText'), dot=el('tokenStatusDot');
  if(ok){ chip.style.background='#053'; chip.style.borderColor='#0fa'; dot.style.background='#10b981'; txt.textContent='ì¸ì¦ë¨'; setActionsEnabled(true); }
  else  { chip.style.background='#2b0a0a'; chip.style.borderColor='#f66'; dot.style.background='#ef4444'; txt.textContent='ë¯¸ì¸ì¦'; setActionsEnabled(false); }
}
function toggleAutoRefresh(on){
  localStorage.setItem('AUTO_REFRESH', on?'1':'0');
  if(on) startAutoRefresh(); else stopAutoRefresh();
}

function saveAdminTokenJJ(){
  var v=el('adminToken')?.value?.trim()||'';
  localStorage.setItem('ADMIN_TOKEN',v);
  testToken();
}

/* ìë™ ìƒˆë¡œê³ ì¹¨ ì œì–´ â€” KPI ìë™ ìƒˆë¡œê³ ì¹¨/í† í° ê²€ì‚¬ (ë©±ë“±) */
if(!window.startAutoRefresh){
  window.__kpiTimer = null;
  window.startAutoRefresh = function(){
    window.stopAutoRefresh();
    refresh().catch(()=>{});
    window.__kpiTimer = setInterval(function(){ refresh().catch(()=>{}); }, 30000);
  };
}
if(!window.stopAutoRefresh){
  window.stopAutoRefresh = function(){
    if(window.__kpiTimer){ clearInterval(window.__kpiTimer); window.__kpiTimer = null; }
  };
}
if(!window.testToken){
  window.testToken = async function(){
    try{
      const r = await fetch(API_BASE+'/api/status', { headers: authHeaders() });
      updateAuthUI(r.ok);
      const auto = (localStorage.getItem('AUTO_REFRESH')==='1');
      if(r.ok && auto) startAutoRefresh(); else stopAutoRefresh();
    }catch(e){
      updateAuthUI(false); stopAutoRefresh();
    }
  };
}

/* í…Œë§ˆ */
(function initTheme(){
  var saved=localStorage.getItem('THEME')||'dark';
  document.documentElement.dataset.theme=saved;
  var btn=el('theme-toggle'); if(btn) btn.textContent=(saved==='dark')?'ë¼ì´íŠ¸ ëª¨ë“œ':'ë‹¤í¬ ëª¨ë“œ';
  if(localStorage.getItem('ADMIN_TOKEN')){ el('adminToken').value=''; } // ìë™ì™„ì„± ë°©ì§€
  setTimeout(function(){
  // í† í° í…ŒìŠ¤íŠ¸ í›„ í† ê¸€ UI ìƒíƒœ ë°˜ì˜
  testToken();
  var chk=document.getElementById('autoRefreshToggle');
  var v=localStorage.getItem('AUTO_REFRESH');
  if(v==null){ localStorage.setItem('AUTO_REFRESH','1'); v='1'; } // ê¸°ë³¸ ON
  if(chk){ chk.checked=(v==='1'); }
}, 200);

})();
function toggleTheme(){
  var now=document.documentElement.dataset.theme==='dark'?'light':'dark';
  document.documentElement.dataset.theme=now; localStorage.setItem('THEME',now);
  var btn=el('theme-toggle'); if(btn) btn.textContent=(now==='dark')?'ë¼ì´íŠ¸ ëª¨ë“œ':'ë‹¤í¬ ëª¨ë“œ';
}

/* ì™„ì „ ë¡œê·¸ì•„ì›ƒ */
function clearAdminTokenJJ(){
  localStorage.removeItem('ADMIN_TOKEN');
  var ip = document.getElementById('adminToken'); if (ip) ip.value='';
  updateAuthUI(false);
  stopAutoRefresh();
  location.reload();
}

/* ë‚ ì§œ ê¸°ë³¸ê°’ */
(function initToday(){
  var t=new Date().toISOString().slice(0,10);
  var d=el('date'); if(d && !d.value) d.value=t;
})();

/* ê²½ë¡œ/ë§í¬ ë„ìš°ë¯¸ */
function normPath(p){ if(!p) return ''; var s=String(p).replace(/\\/g,'/'); if(!s.startsWith('/')) s='/'+s; return s; }
function absUrl(p){ return API_BASE + normPath(p); }
function showLink(p){
  var row=el('resultRow'), a=el('outLink'); if(!row||!a) return;
  var url=absUrl(p); a.href=url; a.textContent='ì—´ê¸°: '+url; row.style.display='block';
}

/* KPI ìƒˆë¡œê³ ì¹¨ íŠ¸ë¦¬ê±°ëŠ” startAutoRefresh()ê°€ ë‹´ë‹¹ */

/* KPI ìƒˆë¡œê³ ì¹¨ ì‹¤ì œ ë¡œì§ */
async function refresh(){
  var date=el('date').value.trim(), kw=el('kw').value.trim();
  try{
    var r = await fetch(API_BASE+'/api/status?date='+encodeURIComponent(date)+'&keyword='+encodeURIComponent(kw), { headers: authHeaders() });
    var j = await r.json();
    el('selTotal').textContent=j.selection_total??'-';
    el('selApproved').textContent=j.selection_approved??'-';
    el('cntCandidate').textContent=(j.state_counts&&j.state_counts.candidate)||0;
    el('cntReady').textContent=(j.state_counts&&j.state_counts.ready)||0;
    el('cntRejected').textContent=(j.state_counts&&j.state_counts.rejected)||0;
    el('comTotal').textContent=j.community_total??'-';
    el('kwTotal').textContent=j.keyword_total??'-';
    el('gateReq').textContent=j.gate_required??15;
    el('gatePass').textContent=j.gate_pass?'í†µê³¼':'ë¯¸í†µê³¼';
    var gs=el('gateSlider'), gv=el('gateVal'); if(gs) gs.value=j.gate_required??15; if(gv) gv.textContent=j.gate_required??15;
  }catch(e){ el('log').textContent='ìƒíƒœ ì˜¤ë¥˜: '+e; }
}

/* ê²Œì´íŠ¸ ì„ê³„ê°’ ì—…ë°ì´íŠ¸ */
async function updateGate(val){
  var v=parseInt(val||'0',10); if(!v){ showToast('ìˆ«ìê°’ í•„ìš”','err'); return; }
  var gs=document.getElementById('gateSlider'); if(gs) gs.disabled=true;
  try{
    var res=await fetch(API_BASE+'/api/config/gate_required',{
      method:'PATCH',
      headers:Object.assign({'Content-Type':'application/json'}, authHeaders()),
      body: JSON.stringify({value:v, gate_required:v}) // ì„œë²„ êµ¬í˜„ ì°¨ì´ ëŒ€ë¹„
    });
    var js=await res.json().catch(()=>({}));
    if(!res.ok || js.error){ throw new Error(js.error || ('HTTP '+res.status)); }

    var newV = (js.gate_required!=null)? js.gate_required : v;
    var req = document.getElementById('gateReq');
    var valSpan = document.getElementById('gateVal');
    if(req) req.textContent = newV;
    if(valSpan) valSpan.textContent = newV;

    await refresh().catch(()=>{});
    showToast('ê²Œì´íŠ¸ ì €ì¥: '+newV,'ok');
  }catch(e){
    showToast('ê²Œì´íŠ¸ ì‹¤íŒ¨: '+e.message,'err');
  }finally{
    if(gs) gs.disabled=false;
  }
}

/* ë³´ê³ ì„œ/ìš”ì•½/ë‚´ë³´ë‚´ê¸° */
async function genReport(){
  var date=el('reportDate').value || new Date().toISOString().slice(0,10);
  var kw=el('reportKw').value.trim();
  try{
    var res=await fetch(API_BASE+'/api/report',{
      method:'POST', headers:Object.assign({'Content-Type':'application/json'}, authHeaders()),
      body: JSON.stringify({date:date, keyword:kw})
    });
    var j=await res.json(); if(j.path) showLink(j.path);
    el('log').textContent=JSON.stringify(j,null,2);
  }catch(e){ el('log').textContent='ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: '+e; }
}
async function enrichKeyword(){
  var kw=el('reportKw').value.trim() || el('kw').value.trim();
  if(!kw){ alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  try{
    var res=await fetch(API_BASE+'/api/enrich/keyword',{
      method:'POST', headers:Object.assign({'Content-Type':'application/json'}, authHeaders()),
      body: JSON.stringify({keyword:kw})
    });
    var j=await res.json();
    if(j.path){ showLink(j.path); el('log').innerHTML='ìš”ì•½ íŒŒì¼ ìƒì„± ì™„ë£Œ: <a href="'+absUrl(j.path)+'" target="_blank" rel="noopener">'+escapeHtml(normPath(j.path))+'</a>'; }
    else{ el('log').textContent=JSON.stringify(j,null,2); }
  }catch(e){ el('log').textContent='í‚¤ì›Œë“œ ìš”ì•½ ì‹¤íŒ¨: '+e; }
}
async function enrichSelection(){
  var kw=el('reportKw').value.trim();
  try{
    var res=await fetch(API_BASE+'/api/enrich/selection',{
      method:'POST', headers:Object.assign({'Content-Type':'application/json'}, authHeaders()),
      body: JSON.stringify({keyword:kw})
    });
    var j=await res.json();
    if(j.path){ showLink(j.path); el('log').innerHTML='ì„ ì •ë³¸ ìš”ì•½ íŒŒì¼ ìƒì„± ì™„ë£Œ: <a href="'+absUrl(j.path)+'" target="_blank" rel="noopener">'+escapeHtml(normPath(j.path))+'</a>'; }
    else{ el('log').textContent=JSON.stringify(j,null,2); }
  }catch(e){ el('log').textContent='ì„ ì •ë³¸ ìš”ì•½ ì‹¤íŒ¨: '+e; }
}
async function exportMd(){
  var date=el('reportDate').value || new Date().toISOString().slice(0,10);
  var kw=el('reportKw').value.trim() || el('kw').value.trim();
  try{
    var res=await fetch(API_BASE+'/api/export/md',{ headers: authHeaders() });
    if(!res.ok){ el('log').textContent='MD ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: '+res.status; return; }
    var blob=await res.blob(), url=URL.createObjectURL(blob);
    var slug=kw?kw.replace(/\s+/g,'_'):''; var fname=slug?('quali_'+date+'_'+slug+'.md'):('quali_'+date+'.md');
    var a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove();
    el('log').textContent='MD íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ';
  }catch(e){ el('log').textContent='MD ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: '+e; }
}
async function exportCsv(){
  var date=el('reportDate').value || new Date().toISOString().slice(0,10);
  var kw=el('reportKw').value.trim() || el('kw').value.trim();
  try{
    var res=await fetch(API_BASE+'/api/export/csv',{ headers: authHeaders() });
    if(!res.ok){ el('log').textContent='CSV ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: '+res.status; return; }
    var blob=await res.blob(), url=URL.createObjectURL(blob);
    var slug=kw?kw.replace(/\s+/g,'_'):''; var fname=slug?('quali_'+date+'_'+slug+'.csv'):('quali_'+date+'.csv');
    var a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove();
    el('log').textContent='CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ';
  }catch(e){ el('log').textContent='CSV ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: '+e; }
}
</script>
<!-- === MD PREVIEW (idempotent) === -->
<script id="md-preview-js">
(function(){
  var hits = [];    // ê²€ìƒ‰ ì¸ë±ìŠ¤ ëª©ë¡
  var cur  = -1;    // í˜„ì¬ í¬ì¸í„°

  function _body(){
  var html = document.getElementById('previewHtmlBody');
  if (html && html.style.display !== 'none') return html; // HTML íƒ­ì´ ë³´ì´ë©´ HTML ì˜ì—­ ì„ íƒ
  return document.getElementById('previewBody');          // ì•„ë‹ˆë©´ MD ì˜ì—­
}
  function _findBox(){ return document.getElementById('previewFind'); }
  function _toast(m,t){ if(typeof showToast==='function') showToast(m,t||'ok'); }

  window.openPreview = function(text){
  var m=document.getElementById('previewModal'); if(!m) return;
  var pre=document.getElementById('previewBody');
  if(pre){ pre.dataset.raw = String(text||''); pre.textContent = pre.dataset.raw; }
  m.style.display='block';            // ë¨¼ì € ë³´ì´ê²Œ
  requestAnimationFrame(function(){   // ë‹¤ìŒ í”„ë ˆì„ì— í˜ì´ë“œ-ì¸
    m.classList.add('on');
  });
  setTimeout(function(){ var box=document.getElementById('previewFind'); if(box){ box.focus(); box.select&&box.select(); }}, 0);
};

window.closePreview = function(){
  var m=document.getElementById('previewModal'); if(!m) return;
  m.classList.remove('on');           // í˜ì´ë“œ-ì•„ì›ƒ ì‹œì‘
  setTimeout(function(){ m.style.display='none'; }, 190); // íŠ¸ëœì§€ì…˜(180ms) ëë‚œ ë’¤ ìˆ¨ê¹€
};
  // === HTML ë¯¸ë¦¬ë³´ê¸° ë³´ì¡° ===
  function mdToHtml(md){
    const esc = s => (s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    let h = '\n' + String(md||'').replace(/\r\n/g,'\n');

    // ì½”ë“œë¸”ë¡ ë³´ì¡´
    const blocks=[]; 
    h = h.replace(/```([\s\S]*?)```/g, (_,code)=>{ blocks.push('<pre><code>'+esc(code)+'</code></pre>'); return `\u0000C${blocks.length-1}\u0000`; });

    // í—¤ë”/ë¦¬ìŠ¤íŠ¸/ë§í¬/ìŠ¤íƒ€ì¼
    h = h.replace(/\n###### (.*)/g,'\n<h6>$1</h6>')
         .replace(/\n##### (.*)/g,'\n<h5>$1</h5>')
         .replace(/\n#### (.*)/g,'\n<h4>$1</h4>')
         .replace(/\n### (.*)/g,'\n<h3>$1</h3>')
         .replace(/\n## (.*)/g,'\n<h2>$1</h2>')
         .replace(/\n# (.*)/g,'\n<h1>$1</h1>')
         .replace(/\n- (.*)/g,'\n<li>$1</li>')
         .replace(/(?:\n<li>.*<\/li>)+/g, m=>'<ul>'+m.replace(/\n/g,'')+'</ul>')
         .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
         .replace(/\*(.+?)\*/g,'<em>$1</em>')
         .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');

    // ë‹¨ë½ ì²˜ë¦¬
    h = h.replace(/\n{2,}/g,'</p><p>').replace(/^\n+|\n+$/g,'');
    h = '<p>'+h+'</p>';

    // ì½”ë“œë¸”ë¡ ë³µì›
    h = h.replace(/\u0000C(\d+)\u0000/g, (_,i)=>blocks[Number(i)]||'');
    return h;
  }
  window.useHtmlTab = function(on){
    var pre=document.getElementById('previewBody');
    var html=document.getElementById('previewHtmlBody');
    if(!pre||!html) return;
    if(on){ pre.style.display='none'; html.style.display='block'; }
    else  { pre.style.display='block'; html.style.display='none'; }
  };
  window.previewHtml = function(){
    try{
      var pre=document.getElementById('previewBody');
      var raw=(pre && pre.dataset && pre.dataset.raw) ? pre.dataset.raw : (pre? pre.textContent : '');
      var box=document.getElementById('previewHtmlBody');
      if(box) box.innerHTML = mdToHtml(raw||'');
      useHtmlTab(true);
    }catch(e){ if(typeof showToast==='function') showToast('HTML ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: '+e.message,'err'); }
  };

  window.previewMd = async function(){
    var btn = (typeof event!=='undefined')? event.target : null;
    try{
      if(btn) btn.disabled = true;
      const r = await fetch(API_BASE+'/api/export/md?preview=1', { headers: authHeaders() });
      if(!r.ok) throw new Error('HTTP '+r.status);
      openPreview(await r.text());
    }catch(e){ _toast('ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: '+e.message,'err'); }
    finally{ if(btn) btn.disabled = false; }
  };

  // --- ë³µì‚¬ ---
  window.copyPreview = async function(){
    var pre=_body(); if(!pre) return;
    try{
      await navigator.clipboard.writeText(pre.textContent||'');
      _toast('ë³µì‚¬ ì™„ë£Œ');
    }catch(e){ _toast('ë³µì‚¬ ì‹¤íŒ¨: '+e.message, 'err'); }
  };

  // --- ê²€ìƒ‰ ---
  function _buildHits(q){
    hits=[]; cur=-1;
    if(!q){ return; }
    var txt = (_body()?.textContent)||'';
    var needle = q.toLowerCase();
    var pos = 0;
    while(true){
      var i = txt.toLowerCase().indexOf(needle, pos);
      if(i<0) break;
      hits.push(i);
      pos = i + needle.length;
      if(hits.length>5000) break; // ì•ˆì „ ê°€ë“œ
    }
  }
  function _scrollTo(idx){
    var pre=_body(); if(!pre || hits.length===0) return;
    var total = (pre.textContent||'').length || 1;
    var i = hits[idx];
    pre.scrollTop = Math.max(0, Math.min(pre.scrollHeight - pre.clientHeight,
                   Math.floor((i/total) * (pre.scrollHeight - pre.clientHeight))));
    _toast((idx+1)+' / '+hits.length);
  }

  window.findInPreview = function(){
    var q = (_findBox()?.value||'').trim();
    if(hits.length===0 || !q){ _buildHits(q); }
    if(hits.length===0){ _toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ','err'); return; }
    cur = (cur+1) % hits.length;
    _scrollTo(cur);
  };
  window.findPrevInPreview = function(){
    var q = (_findBox()?.value||'').trim();
    if(hits.length===0 || !q){ _buildHits(q); }
    if(hits.length===0){ _toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ','err'); return; }
    cur = (cur-1+hits.length) % hits.length;
    _scrollTo(cur);
  };

  // --- ë‹¨ì¶•í‚¤: Esc ë‹«ê¸° / Ctrl|âŒ˜+F ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ / Enter ë‹¤ìŒ / Shift+Enter ì´ì „
  window.addEventListener('keydown', function(ev){
    var modal = document.getElementById('previewModal');
    if(!modal || modal.style.display==='none') return;

    if(ev.key==='Escape'){ ev.preventDefault(); closePreview(); return; }

    var meta = ev.ctrlKey || ev.metaKey;
    if(meta && (ev.key==='f' || ev.key==='F')){
      ev.preventDefault();
      var box = _findBox(); if(box){ box.focus(); box.select(); }
      return;
    }
    if(ev.key==='Enter'){
      ev.preventDefault();
      if(ev.shiftKey) findPrevInPreview(); else findInPreview();
      return;
    }
  });
})();
</script>
<!-- === /MD PREVIEW === -->
<script>


/* ===== ë¹„ë™ê¸° ì‘ì—…(SSE) ===== */
let currentJob=null, es=null;
function appendSseLog(s){ var box=el('taskLog'); box.textContent += (s.endsWith('\n')? s : s+'\n'); box.scrollTop = box.scrollHeight; }
function stopStream(){ if(es){ es.close(); es=null; } }
async function startFlow(kind){
  stopStream();
  var r = await fetch(API_BASE+'/api/tasks/flow',{ method:'POST',
    headers:Object.assign({'Content-Type':'application/json'}, authHeaders()),
    body: JSON.stringify({kind:kind})
  });
  var j = await r.json(); currentJob=j.job_id;
  el('q-info').textContent = 'job='+currentJob+' ('+j.kind+')';
  appendSseLog('> started '+j.kind+' job='+currentJob);
  openStream(currentJob);
}
async function startKeyword(){
  var kw = el('kwInput').value.trim(); if(!kw){alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  stopStream();
  var r = await fetch(API_BASE+'/api/tasks/flow',{ method:'POST',
    headers:Object.assign({'Content-Type':'application/json'}, authHeaders()),
    body: JSON.stringify({kind:'keyword',keyword:kw})
  });
  var j = await r.json(); currentJob=j.job_id;
  el('q-info').textContent = 'job='+currentJob+' (keyword:'+kw+')';
  appendSseLog('> started keyword='+kw+' job='+currentJob);
  openStream(currentJob);
}
function openStream(job){
  stopStream();
  var token=(localStorage.getItem('ADMIN_TOKEN')||'').trim();
  var url = API_BASE+'/api/tasks/'+job+'/stream' + (token?('?token='+encodeURIComponent(token)):'');
  es = new EventSource(url);
  es.onmessage = ev=>{ if(ev.data) appendSseLog(ev.data); };
  es.addEventListener('end', ev=>{ appendSseLog('\n<END> '+ev.data); stopStream(); });
  es.onerror = ()=> appendSseLog('[SSE error] ì¬ì‹œë„ ì¤‘â€¦');
}

/* ===== ëª¨ë‹¬ & ë™ê¸° í´ë°± ===== */
function lockButtons(lock){ document.querySelectorAll('section.card button').forEach(b=>b.disabled=!!lock); el('cancelBtn').disabled=!lock; }
function openModal(){ el('jobModal').style.display='block'; }
function closeModal(){ el('jobModal').style.display='none'; stopStream(); currentJob=null; lockButtons(false); }
async function cancelJob(){ if(!currentJob) return; try{ await fetch(API_BASE+'/api/tasks/'+currentJob+'/cancel',{method:'POST',headers:authHeaders()}); }catch{} }

function renderSteps(st){
  var box=el('steps'); if(!box) return;
  var arr=(st && Array.isArray(st.steps))?st.steps:[];
  if(arr.length===0){ box.innerHTML='<div class="task-log">í‘œì‹œí•  ë‹¨ê³„ ì—†ìŒ</div>'; return; }
  box.innerHTML='';
  for(var i=0;i<arr.length;i++){
    var s=arr[i]||{}, num=i+1, state=s.ok?'OK':'ERR', name=s.cmd||s.name||'';
    var stdout=s.stdout||'', stderr=s.stderr?('\nERR: '+s.stderr):'';
    var div=document.createElement('div'); div.className='task-log';
    div.textContent='['+num+'] '+state+' '+name+'\n'+stdout+stderr;
    box.appendChild(div);
  }
}
function drawTimeline(st){
  var cvs=el('timeline'); if(!cvs||!cvs.getContext) return;
  var ctx=cvs.getContext('2d'); ctx.clearRect(0,0,cvs.width,cvs.height);
  var arr=(st&&st.steps)||[]; if(!arr.length) return;
  var H=20, PAD=10, W=cvs.width-2*PAD;
  var hasTime = arr.some(x=>x.t_start||x.t_end);
  if(hasTime){
    var times=arr.map(x=>({s:new Date(x.t_start||Date.now()), e:new Date(x.t_end||Date.now())}));
    var t0=Math.min.apply(null,times.map(t=>t.s)), t1=Math.max.apply(null,times.map(t=>t.e));
    var span=Math.max(1,t1-t0);
    arr.forEach(function(it,i){
      var ss=new Date(it.t_start||Date.now()), ee=new Date(it.t_end||ss);
      var x=((ss-t0)/span)*W+PAD, w=Math.max(2,((ee-ss)/span)*W), y=10+i*(H+6);
      ctx.fillStyle=(it.ok===false?getCss('--err'):(it.ok===true?getCss('--ok'):getCss('--acc'))); ctx.fillRect(x,y,w,H);
    });
  }else{
    var w = Math.max(2, W/arr.length);
    arr.forEach(function(it,i){
      var y=10+i*(H+6);
      ctx.fillStyle=(it.ok===false?getCss('--err'):(it.ok===true?getCss('--ok'):getCss('--acc'))); ctx.fillRect(PAD + i*w, y, w-4, H);
    });
  }
}

/* ë¹„ë™ê¸° ì§€ì› ì—¬ë¶€ ì²´í¬ */
let HAS_TASKS=false;
async function checkTasks(){
  try{ var r=await fetch(API_BASE+'/api/tasks/recent?limit=1',{headers:authHeaders()}); HAS_TASKS=r.ok; }
  catch{ HAS_TASKS=false; }
}
checkTasks();

/* ë™ê¸°/ë¹„ë™ê¸° ëŸ°ì²˜ */
async function startJob(url, body){
  lockButtons(true); openModal(); el('jobMeta').textContent='ì‘ì—… ì¤€ë¹„ ì¤‘â€¦'; el('steps').innerHTML='';
  try{
    var res=await fetch(url,{
      method:'POST',
      headers: body ? Object.assign({'Content-Type':'application/json'}, authHeaders()) : authHeaders(),
      body: body ? JSON.stringify(body) : null
    });
    if(res.ok){
      var js=await res.json().catch(()=>({}));
      if(js.job_id){
        currentJob=js.job_id;
        var t=(localStorage.getItem('ADMIN_TOKEN')||'').trim();
        var sseUrl = API_BASE+'/api/tasks/'+js.job_id+'/stream' + (t?('?token='+encodeURIComponent(t)):'');
        es=new EventSource(sseUrl);
        es.addEventListener('end', ()=>{ es.close(); es=null; lockButtons(false); refresh(); });
        return;
      }
    }
    await syncFallback(kindFromBody(body||{}));
  }catch{ await syncFallback(kindFromBody(body||{})); }
  lockButtons(false);
}
function kindFromBody(b){ return b.kind || 'unknown'; }

/* í´ë°± ì‹¤í–‰ â€” mergedëŠ” dailyâ†’community ìˆœì°¨ í˜¸ì¶œ */
async function syncFallback(kind, body){
  // í´ë°± ì‹¤í–‰ë„ í•­ìƒ ëª¨ë‹¬ì„ ë„ì›Œì¤€ë‹¤
  openModal();
  lockButtons(true);
  el('jobMeta').textContent = 'ë™ê¸° ì‹¤í–‰(í´ë°±) â€” ' + kind;
  el('steps').innerHTML = '';

  // ìœ í‹¸
  const mkStep   = s   => ({ ok: !!s.ok, cmd: s.cmd || s.name || '', stdout: s.stdout || '', stderr: s.stderr || '' });
  const mergeSteps = (dst, js) => (js.steps || []).forEach(s => dst.steps.push(mkStep(s)));

  try{
    const st = { name: 'flow-'+kind, status: 'running', steps: [] };

    if (kind === 'merged') {
      // daily â†’ community ìˆœì°¨ ì‹¤í–‰
      let a = await fetch(API_BASE + '/api/flow/daily',     { method:'POST', headers: authHeaders() });
      a = await a.json().catch(()=>({ok:false,steps:[]}));
      mergeSteps(st, a); if (!a.ok) st.status = 'error';
      renderSteps(st); drawTimeline(st);

      let b = await fetch(API_BASE + '/api/flow/community', { method:'POST', headers: authHeaders() });
      b = await b.json().catch(()=>({ok:false,steps:[]}));
      mergeSteps(st, b); if (!b.ok) st.status = 'error';

    } else if (kind === 'daily' || kind === 'community') {
      let r = await fetch(API_BASE + '/api/flow/' + kind, { method:'POST', headers: authHeaders() });
      r = await r.json().catch(()=>({ok:false,steps:[]}));
      mergeSteps(st, r); if (!r.ok) st.status = 'error';

    } else if (kind === 'keyword') {
      let r = await fetch(API_BASE + '/api/flow/keyword', {
        method:'POST',
        headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
        body: JSON.stringify(body || {})
      });
      r = await r.json().catch(()=>({ok:false,steps:[]}));
      mergeSteps(st, r); if (!r.ok) st.status = 'error';

    } else {
      el('log').textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì—…: ' + kind;
      return;
    }

    if (st.status === 'running') st.status = 'done';
    renderSteps(st); drawTimeline(st);
    el('jobMeta').textContent = 'ì‘ì—…: ' + st.name + ' Â· ìƒíƒœ: ' + st.status;
    await refresh();

  } catch (e) {
    el('log').textContent = 'ë™ê¸° ì‹¤í–‰ ì‹¤íŒ¨: ' + e;
  } finally {
    lockButtons(false);
  }
}


/* ìš´ì˜ ë²„íŠ¼ */
async function runDaily(){ if(HAS_TASKS) await startJob(API_BASE+'/api/tasks/flow', {kind:'daily'}); else await syncFallback('daily'); }
async function runCommunity(){ if(HAS_TASKS) await startJob(API_BASE+'/api/tasks/flow', {kind:'community'}); else await syncFallback('community'); }
async function runKeyword(){
  var keyword=el('kw').value.trim(); if(!keyword){ alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if(HAS_TASKS) await startJob(API_BASE+'/api/tasks/flow', {kind:'keyword', keyword:keyword, use_external_rss:true});
  else await syncFallback('keyword', {keyword:keyword, use_external_rss:true});
}
async function runMerged(){ await syncFallback('merged'); }

/* ìŠ¹ì¸ UI ì—´ê¸° */
async function startApprove(){
  lockButtons(true);
  try{
    var r=await fetch(API_BASE+'/api/approve-ui/start',{method:'POST', headers:authHeaders()});
    var d=await r.json().catch(()=>({}));
    var ui=d.ui_url || API_BASE;
    el('log').textContent=JSON.stringify(d,null,2);
    window.open(ui,'_blank','noopener');
  }catch(e){ el('log').textContent='ìŠ¹ì¸ UI ì—´ê¸° ì‹¤íŒ¨: '+e; }
  lockButtons(false);
}

/* ìµœê·¼ ì‘ì—…/Ready ëª©ë¡ */
async function showRecent(){
  try{
    var r=await fetch(API_BASE+'/api/tasks/recent?limit=20',{headers:authHeaders()});
    el('log').textContent=JSON.stringify(await r.json(),null,2);
  }catch(e){ el('log').textContent='ìµœê·¼ ì‘ì—… ì‹¤íŒ¨: '+e; }
}
async function loadReady(){
  var date=el('date')?.value?.trim()||'', keyword=el('kw')?.value?.trim()||'';
  try{
    var r=await fetch(API_BASE+'/api/items?state=ready&date='+encodeURIComponent(date)+'&keyword='+encodeURIComponent(keyword), { headers: authHeaders() });
    var j=await r.json();
    renderReadyList(j.items||[]);
  }catch(e){ el('log').textContent='Ready ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e; }
}
function renderReadyList(items){
  var $=el('readyList'); if(!$) return;
  if(!items.length){ $.innerHTML='<div class="row" style="color:var(--muted)">Ready í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  $.innerHTML = items.map(function(a){
    var id=a.id||'', src=a.source||'', url=a.url||'#', title=a.title||'(ì œëª© ì—†ìŒ)';
    var v=(a.value_score!=null? a.value_score : a.total_score)||0, dt=a.doc_type||'text', note=a.editor_note||'';
    return '<div class="card">'
      + '<div class="row" style="justify-content:space-between;align-items:center">'
      +   '<div><b>'+escapeHtml(title)+'</b><br/><small>'+escapeHtml(src)+'</small></div>'
      +   '<a href="'+url+'" target="_blank" rel="noopener">ì—´ê¸°</a>'
      + '</div>'
      + '<div class="row" style="gap:12px;margin:8px 0">'
      +   '<span class="pill">í˜•ì‹: '+escapeHtml(dt)+'</span>'
      +   '<span class="pill">V: '+String(v)+'</span>'
      + '</div>'
      + '<label>í¸ì§‘ì¥ í•œë§ˆë””</label>'
      + '<textarea id="note-'+id+'" rows="2" style="width:100%">'+escapeHtml(note)+'</textarea>'
      + '<div class="row" style="justify-content:flex-end;margin-top:8px">'
      +   '<button class="primary" onclick="publishItem(\''+id+'\')">ë°œí–‰</button>'
      + '</div>'
      + '</div>';
  }).join('');
}
async function publishItem(id){
  var noteEl=el('note-'+id); var editor_note=noteEl? noteEl.value : '';
  try{
    var r=await fetch(API_BASE+'/api/items/'+encodeURIComponent(id)+'/publish',{
      method:'POST', headers:Object.assign({'Content-Type':'application/json'}, authHeaders()),
      body: JSON.stringify({ editor_note: editor_note, approve: true })
    });
    var j=await r.json(); if(!r.ok || j.ok!==true) throw new Error(j.detail||'ë°œí–‰ ì‹¤íŒ¨');
    var card=(noteEl && noteEl.closest('.card')); if(card) card.remove();
    refresh().catch(function(){});
  }catch(e){ alert('ë°œí–‰ ì‹¤íŒ¨: '+e); }
}
</script>
<!-- === FOOTER RUNTIME BADGE === -->
<div id="runtime-badge" style="position:fixed;bottom:6px;left:12px;z-index:9999;font:12px/1.4 system-ui;color:#aaa;"></div>
<script>
(async () => {
  try {
    const r = await fetch('/api/debug/runtime');
    const j = await r.json();
    const c = j.commit ? ` Â· COMMIT ${String(j.commit).slice(0,7)}` : '';
    document.getElementById('runtime-badge').textContent =
      `SERVICE ${j.service} Â· REV ${j.revision}${c} Â· ${j.time_kst}`;
  } catch(e) { /* ë¬´ì‹œ */ }
})();
</script>
<!-- === /FOOTER RUNTIME BADGE === -->
<!-- BACKUP BADGE -->
<div id="backup-badge" style="position:fixed;bottom:6px;right:12px;z-index:9999;font:12px/1.4 system-ui;"></div>
<script>
(async()=>{
  try{
    const r = await fetch('/api/backup/status'); const j = await r.json();
    const el = document.getElementById('backup-badge');
    if(!j.ts){ el.textContent='ë°±ì—… ìƒíƒœ: ì •ë³´ ì—†ìŒ'; return; }
    const ageH = (Date.now()/1000 - j.ts)/3600;
    const ok = j.ok && ageH < 26;
    el.style.color = ok ? '#0f0' : '#f66';
    const dt = new Date(j.ts*1000).toLocaleString('ko-KR',{timeZone:'Asia/Seoul'});
    el.textContent = (ok?'ë°±ì—… OK ':'ë°±ì—… ì§€ì—° ') + `Â· ${dt}`;
  }catch(e){}
})();
</script>
<!-- === MD PREVIEW MODAL (idempotent) === -->
<div id="previewModal"
     role="dialog" aria-modal="true" aria-labelledby="previewTitle"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:10000;"
     onclick="if(event.target===this) closePreview()">
  <div class="panel" tabindex="-1"
       style="max-width:960px; margin:60px auto; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px;">
    <div class="row" style="justify-content:space-between;align-items:center; margin-top:0;">
      <h3 id="previewTitle" style="margin:0">MD/HTML ë¯¸ë¦¬ë³´ê¸°</h3>
      <div class="row" style="gap:6px">
        <input id="previewFind" placeholder="ê²€ìƒ‰(Ctrl/âŒ˜+F)" style="padding:6px 8px;width:220px">
        <button onclick="findInPreview()">ì°¾ê¸°</button>
        <button onclick="findPrevInPreview()">ì´ì „</button>
        <button onclick="copyPreview()">ë³µì‚¬</button>
        <button onclick="useHtmlTab(false)">MDë³´ê¸°</button>
        <button onclick="previewHtml()">HTMLë³´ê¸°</button>
        <span class="pill" title="ë‹¨ì¶•í‚¤: Ctrl/âŒ˜+F=ê²€ìƒ‰, Enter=ë‹¤ìŒ, Shift+Enter=ì´ì „, Esc=ë‹«ê¸°">ë‹¨ì¶•í‚¤</span>
        <button onclick="closePreview()">ë‹«ê¸°(Esc)</button>
      </div> 
    </div>

    <!-- MD ì›ë¬¸ ì˜ì—­ -->
    <pre id="previewBody"
         style="white-space:pre-wrap; background:var(--panel); border:1px solid var(--line); border-radius:8px; padding:10px; max-height:60vh; overflow:auto; font:12px/1.5 ui-monospace,Consolas,monospace;"
         aria-live="polite"></pre>

    <!-- HTML ë Œë” ì˜ì—­ -->
    <div id="previewHtmlBody"
         style="display:none; background:var(--panel); border:1px solid var(--line); border-radius:8px; padding:16px; max-height:60vh; overflow:auto; font:14px/1.6 system-ui"></div>
  </div>
</div>
<!-- === /MD PREVIEW MODAL === -->


<div id="toast" role="status" aria-live="polite"></div>
<!-- === Admin Quick Panel (ë³´ê³ ì„œ/ìš”ì•½/Export) === -->
<div
  id="adminOps"
  role="complementary"
  aria-label="Admin operations panel"
  style="position:fixed; right:16px; top:90px; z-index:9999; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:12px; width:260px;"
>
  <div style="font-weight:600; margin-bottom:8px; display:flex; align-items:center; gap:8px;">
    <span aria-hidden="true">ğŸ› </span><span>Admin Ops</span>
  </div>

  <button type="button" id="btnReport" class="primary" style="width:100%; margin-bottom:6px;">ì¼ì¼ ë³´ê³ ì„œ ìƒì„±</button>
  <a id="linkReport" class="pill" href="#" target="_blank" rel="noopener" style="display:none;">ë³´ê³ ì„œ ì—´ê¸°</a>

  <hr style="margin:10px 0; border:none; border-top:1px solid var(--line);" />

  <button type="button" id="btnEnrichAll" style="width:100%; margin-bottom:6px;">í‚¤ì›Œë“œ ìš”ì•½/ë²ˆì—­</button>
  <a id="linkEnrichAll" class="pill" href="#" target="_blank" rel="noopener" style="display:none;">ALL.md ì—´ê¸°</a>

  <button type="button" id="btnEnrichSel" style="width:100%; margin:8px 0 6px;">ì„ ì •ë³¸ ìš”ì•½/ë²ˆì—­</button>
  <a id="linkEnrichSel" class="pill" href="#" target="_blank" rel="noopener" style="display:none;">SELECTED.md ì—´ê¸°</a>

  <hr style="margin:10px 0; border:none; border-top:1px solid var(--line);" />

  <button type="button" id="btn-export-md"  style="width:100%; margin-bottom:6px;">Export Markdown</button>
  <button type="button" id="btn-export-csv" style="width:100%;">Export CSV</button>
</div>

<script>
/* === Admin Ops: canonical function block (ì´ ë¸”ë¡ì€ í•œ ê³³ì—ë§Œ ì¡´ì¬) === */
(function () {
  'use strict';

  // --- helpers ---------------------------------------------------------------
  const $ = (id) => document.getElementById(id);
  const API = (p) => (typeof API_BASE === 'string' ? API_BASE : '') + p;
  const headers = () => {
    if (typeof authHeaders === 'function') return authHeaders();
    const token = localStorage.getItem('ADMIN_TOKEN') || '';
    return { 'Authorization': token ? 'Bearer ' + token : '', 'Accept': 'application/json' };
  };
  const toast = (msg, type) => {
    if (typeof _toast === 'function') _toast(msg, type);
    else alert(msg);
  };

  // ê³µí†µ fetch(Json/Text ìë™ íŒŒì‹±)
  async function request(path, opts = {}) {
    const r = await fetch(API(path), { headers: headers(), ...opts });
    const ct = r.headers.get('content-type') || '';
    let data = null;
    try {
      data = ct.includes('application/json') ? await r.json()
           : ct.includes('text/')            ? await r.text()
           : await r.blob();
    } catch (_) {}
    return { ok: r.ok, status: r.status, data, res: r };
  }

  // ë²„íŠ¼ ë¹„í™œì„±/ë³µêµ¬
  function withBusy(btn, fn) {
    return async function () {
      if (!btn) return;
      if (btn.dataset.busy === '1') return; // ë””ë°”ìš´ìŠ¤
      btn.dataset.busy = '1';
      const prev = btn.disabled;
      btn.disabled = true;
      try { await fn(); }
      finally { btn.disabled = prev; btn.dataset.busy = '0'; }
    };
  }

  // --- 1) ì¼ì¼ ë³´ê³ ì„œ ìƒì„± ---------------------------------------------------
  async function _genReport() {
    const link = $('linkReport');
    if (link) link.style.display = 'none';
    const { ok, status, data } = await request('/api/report', { method: 'POST' });
    if (ok && data && data.path) {
      if (link) {
        link.href = '/' + String(data.path).replace(/^\/?/, '');
        link.style.display = 'inline';
      }
      toast('ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');
    } else {
      toast('ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: ' + (data?.error || status), 'err');
    }
  }
  if (!window.genReport) window.genReport = _genReport;

  // --- 2) í‚¤ì›Œë“œ ì „ì²´ ìš”ì•½/ë²ˆì—­ ---------------------------------------------
  async function _enrichKeyword() {
    const link = $('linkEnrichAll');
    if (link) link.style.display = 'none';
    const { ok, status, data } = await request('/api/enrich/keyword', { method: 'POST' });
    if (ok && data && data.path) {
      if (link) {
        link.href = '/' + String(data.path).replace(/^\/?/, '');
        link.style.display = 'inline';
      }
      toast('ì „ì²´ ìš”ì•½/ë²ˆì—­ ì™„ë£Œ', 'ok');
    } else {
      toast('ìš”ì•½/ë²ˆì—­ ì‹¤íŒ¨: ' + (data?.error || status), 'err');
    }
  }
  if (!window.enrichKeyword) window.enrichKeyword = _enrichKeyword;

  // --- 3) ì„ ì •ë³¸ ìš”ì•½/ë²ˆì—­ ---------------------------------------------------
  async function _enrichSelection() {
    const link = $('linkEnrichSel');
    if (link) link.style.display = 'none';
    const { ok, status, data } = await request('/api/enrich/selection', { method: 'POST' });
    if (ok && data && data.path) {
      if (link) {
        link.href = '/' + String(data.path).replace(/^\/?/, '');
        link.style.display = 'inline';
      }
      toast('ì„ ì •ë³¸ ìš”ì•½/ë²ˆì—­ ì™„ë£Œ', 'ok');
    } else {
      toast('ìš”ì•½/ë²ˆì—­ ì‹¤íŒ¨: ' + (data?.error || status), 'err');
    }
  }
  if (!window.enrichSelection) window.enrichSelection = _enrichSelection;

  // --- 4) Export MD/CSV (Blob ë‹¤ìš´ë¡œë“œ) --------------------------------------
  async function _exportMd() {
    const { ok, status, data, res } = await request('/api/export/md', { method: 'GET' });
    if (!ok) return toast('MD Export ì‹¤íŒ¨: ' + status, 'err');
    const text = typeof data === 'string' ? data : await res.text();
    const blob = new Blob([text], { type: 'text/markdown;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'latest_report.md';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  if (!window.exportMd) window.exportMd = _exportMd;

  async function _exportCsv() {
    const { ok, status, res } = await request('/api/export/csv', { method: 'GET' });
    if (!ok) return toast('CSV Export ì‹¤íŒ¨: ' + status, 'err');
    const blob = await res.blob();
    const cd = res.headers.get('content-disposition') || '';
    const m = /filename\*=UTF-8''([^;]+)|filename="?([^"]+)"?/i.exec(cd);
    const fname = decodeURIComponent(m?.[1] || m?.[2] || 'latest_report.csv');
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fname;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  if (!window.exportCsv) window.exportCsv = _exportCsv;

  // --- 5) ì•ˆì „í•œ ë°°ì„ (ì¤‘ë³µ ë°©ì§€: data-wired í”Œë˜ê·¸ ì‚¬ìš©) ---------------------
  function safeWire(id, handler) {
    const el = $(id);
    if (!el || el.dataset.wired === '1') return;
    // ë²„íŠ¼ ë¹„í™œì„±/ë³µêµ¬ë¥¼ ìë™ ì ìš©
    el.onclick = withBusy(el, handler);
    el.dataset.wired = '1';
  }
  safeWire('btnReport',      window.genReport);
  safeWire('btnEnrichAll',   window.enrichKeyword);
  safeWire('btnEnrichSel',   window.enrichSelection);
  safeWire('btn-export-md',  window.exportMd);
  safeWire('btn-export-csv', window.exportCsv);
})();
</script>

</body>
</html>
