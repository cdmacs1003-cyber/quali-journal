<!doctype html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <title>QualiJournal Admin — Lite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#ffffff; --ink:#1a1d20; --muted:#64748b; --line:#e2e8f0;
      --acc:#2563eb; --card:#ffffff; --panel:#f8fafc;
    }
    [data-theme="dark"]{
      --bg:#0b0e12; --ink:#e9eef5; --muted:#8ea1b2; --line:#223047;
      --acc:#1e90ff; --card:#10161d; --panel:#0f141b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font:14px/1.6 system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    main{padding:16px;display:grid;grid-template-columns: 300px 1fr;gap:16px}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:var(--card)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    button{padding:8px 12px;border:1px solid var(--line);background:var(--panel);color:var(--ink);border-radius:8px;cursor:pointer}
    button.primary{background:var(--acc);border-color:var(--acc);color:#fff}
    input{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:var(--card);color:var(--ink)}
    #log{white-space:pre-wrap;background:var(--panel);border:1px dashed var(--line);padding:10px;border-radius:8px;margin-top:8px;max-height:50vh;overflow:auto}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi .box{border:1px solid var(--line);border-radius:8px;padding:10px;background:var(--card)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<header>
  <div>
    <h1>QualiJournal — Lite Admin</h1>
    <div class="sub">하루 한 키워드 · 인간 검수 · 승인≥15 · 원클릭 발행</div>
  </div>
  <div class="sub">API: <span id="api">http://127.0.0.1:8010</span>
    <button id="theme-toggle" style="margin-left:8px;" onclick="toggleTheme()">다크 모드</button>
  </div>
</header>

<main>
  <!-- 좌: 상태 + 승인 UI -->
  <section class="card">
    <h3>상태</h3>
    <div class="row">
      <input id="date" />
      <input id="kw" value="IPC-A-610" />
      <button onclick="refresh()" class="primary">새로고침</button>
    </div>
    <div class="kpi">
      <div class="box">선정본 총량: <b id="selTotal">-</b></div>
      <div class="box">선정본 승인: <b id="selApproved">-</b></div>
      <div class="box">커뮤니티 후보: <b id="comTotal">-</b></div>
      <div class="box">키워드 특집: <b id="kwTotal">-</b></div>
    </div>
    <div class="row">
      <span class="pill">게이트(승인 ≥ <span id="gateReq">15</span>): <b id="gatePass">-</b></span>
      <button onclick="startApprove()">승인 UI 열기</button>
      <a class="pill" href="http://127.0.0.1:8765" target="_blank" rel="noopener">http://127.0.0.1:8765</a>
    </div>
  </section>

  <!-- 우: 액션 -->
  <section class="card">
    <h3>운영</h3>
    <div class="row">
      <button onclick="flow('/api/flow/daily')" class="primary">일일 플로우</button>
      <button onclick="flow('/api/flow/community')">커뮤니티 전용</button>
    </div>
    <h4 style="margin-top:4px">키워드 특집</h4>
    <div class="row">
      <button onclick="flowKw()">수집→승인Top20→동기화→발행</button>
    </div>
    <div id="log">여기에 결과 로그가 표시됩니다.</div>
  </section>
</main>

<script>
const API = document.getElementById('api').textContent;

function todayISO(){ return new Date().toISOString().slice(0,10); }
(function init(){ const d=document.getElementById('date'); if(d && !d.value) d.value = todayISO(); })();

async function refresh(){
  const date = document.getElementById('date').value.trim();
  const kw = document.getElementById('kw').value.trim();
  const q = new URLSearchParams({date, keyword: kw}).toString();
  const res = await fetch(`${API}/api/status?${q}`);
  const j = await res.json();
  selTotal.textContent = j.selection_total ?? '-';
  selApproved.textContent = j.selection_approved ?? '-';
  comTotal.textContent = j.community_total ?? '-';
  kwTotal.textContent = j.keyword_total ?? '-';
  gateReq.textContent = j.gate_required ?? 15;
  gatePass.textContent = j.gate_pass ? "통과" : "미통과";
}
async function flow(path){
  const r = await fetch(API+path,{method:'POST'});
  showLog(await r.json()); await refresh();
}
async function flowKw(){
  const keyword = kw.value.trim();
  const r = await fetch(API+'/api/flow/keyword',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({keyword, use_external_rss:true})
  });
  showLog(await r.json()); await refresh();
}
async function startApprove(){
  const r = await fetch(API+'/api/approve-ui/start',{method:'POST'});
  showLog(await r.json());
}
function showLog(j){ log.textContent = JSON.stringify(j,null,2); }

// 테마 토글
function toggleTheme(){
  const html = document.documentElement;
  const btn = document.getElementById('theme-toggle');
  if(html.getAttribute('data-theme') === 'dark'){
    html.setAttribute('data-theme','light'); if(btn) btn.textContent = '다크 모드';
  } else {
    html.setAttribute('data-theme','dark'); if(btn) btn.textContent = '라이트 모드';
  }
}
</script>
</body>
</html>
